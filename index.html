<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pittsburgh Tract Explorer</title>
  <!-- Turf.js for spatial ops -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>
  <style>
    body { font-family: Arial; margin:20px; }
    #map { width:60%; height:400px; margin:auto }
    #charts { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      grid-gap:20px; 
      width:80%; 
      margin:40px auto 
    }
    .chart { width:100%; height:300px }
  </style>
</head>
<body>

<h1 style="text-align:center">Pittsburgh Tract Explorer</h1>
<div id="map"></div>
<div id="charts">
  <div id="chart1" class="chart"></div>
  <div id="chart2" class="chart"></div>
  <div id="chart3" class="chart"></div>
  <div id="chart4" class="chart"></div>
</div>

<script>
Promise.all([
  fetch("census_tracts.geojson").then(r=>r.json()),
  fetch("City_of_Pittsburgh_Neighborhoods(2).geojson").then(r=>r.json()),
  fetch("combined_data.json").then(r=>r.json())
]).then(([tractsGeo, neighGeo, combined])=>{

  // 1) Build a dynamic GEOID â†’ HOOD map via centroid-in-polygon
  const hoodMap = {};
  tractsGeo.features.forEach(f=>{
    const center = turf.centroid(f);
    const geoid = f.properties.GEOID;
    const found = neighGeo.features.find(n=>turf.booleanPointInPolygon(center,n));
    hoodMap[geoid] = found ? found.properties.HOOD : "Unknown";
  });

  // 2) Prep lists
  const metrics = [
    "Median home value",
    "Median household income",
    "Median monthly contract rent",
    "Vacant housing units"
  ];
  const geoidList = tractsGeo.features.map(f=>f.properties.GEOID);
  const hoodList  = geoidList.map(g=>hoodMap[g]);
  const hoodToGeo = {};
  geoidList.forEach((g,i)=> {
    const h = hoodList[i];
    (hoodToGeo[h]||(hoodToGeo[h]=[])).push(g);
  });

  const palette = [ // Plotly qualitative
    "#636efa","#ef553b","#00cc96","#ab63fa","#ffa15a",
    "#19d3f3","#ff6692","#b6e880","#ff97ff","#fecb52"
  ];
  let selectedHood = null;

  // 3) Draw base map
  Plotly.newPlot("map",[{
    type: "choroplethmapbox",
    geojson: tractsGeo,
    locations: geoidList,
    z: Array(geoidList.length).fill(0),
    colorscale: [[0,"rgba(0,0,0,0)"],[1,"rgba(0,0,0,0)"]],
    zmin:0,zmax:1,
    featureidkey:"properties.GEOID",
    marker:{opacity:1,
      line:{
        color: Array(geoidList.length).fill("#555555"),
        width: Array(geoidList.length).fill(0.5)
      }
    },
    customdata: geoidList,
    text: hoodList,
    hovertemplate:
      "Tract %{location}<br>Neighborhood: %{text}<extra></extra>",
    showscale:false
  }],{
    mapbox:{style:"open-street-map",zoom:11,center:{lat:40.4406,lon:-79.9959}},
    margin:{t:30,r:0,l:0,b:0},
    clickmode:"event",
    title:"Click any tract to select its neighborhood"
  });

  // 4) Initial charts (All Pittsburgh average)
  function drawAll() {
    metrics.forEach((m,mi)=>{
      const df = combined.filter(d=>d.GEOID==="All Pittsburgh");
      Plotly.newPlot("chart"+(mi+1),[{
        x: df.map(d=>d.Year),
        y: df.map(d=>d[m]),
        mode:"lines+markers", name:"All Pittsburgh",
        line:{color:palette[0]}, marker:{color:palette[0]}
      }], {
        title:m, xaxis:{title:"Year"}, yaxis:{title:m}
      });
    });
  }
  drawAll();

  // 5) Update on click
  function update(hood) {
    selectedHood = (hood===selectedHood?null:hood);
    const inHood = selectedHood? hoodToGeo[selectedHood]: [];
    // restyle map borders
    const colors = geoidList.map(g=> inHood.includes(g)? palette[0]:"#555555");
    const widths = geoidList.map(g=> inHood.includes(g)? 3:0.5);
    Plotly.restyle("map",{
      "marker.line.color":[colors],
      "marker.line.width":[widths]
    });

    if(!selectedHood) return drawAll();

    // sum per-year over all tracts in neighborhood
    const years = Array.from(new Set(combined.map(d=>d.Year))).sort();
    metrics.forEach((m,mi)=>{
      const sums = years.map(y=>
        combined
          .filter(d=>d.Year===y && inHood.includes(d.GEOID))
          .reduce((a,d)=>a+(d[m]||0),0)
      );
      Plotly.react("chart"+(mi+1),[{
        x: years, y: sums,
        mode:"lines+markers",
        name:selectedHood,
        line:{color:palette[0]},
        marker:{color:palette[0]}
      }],{
        title:`${m}: ${selectedHood}`,
        xaxis:{title:"Year"}, yaxis:{title:m}
      });
    });
  }

  // attach click
  document.getElementById("map").on('plotly_click', ev=>{
    const geoid = ev.points[0].customdata;
    update( hoodMap[geoid] );
  });

}).catch(console.error);
</script>

</body>
</html>
