<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pittsburgh Neighborhood Explorer</title>
  <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>
  <style>
    body { font-family: Arial; margin:20px; }
    #top { display:flex; gap:20px; width:80%; margin:auto; }
    #map { flex:1; height:400px; }
    #bar-chart { flex:1; height:400px; }
    #charts {
      display:grid; grid-template-columns:1fr 1fr; grid-gap:20px;
      width:80%; margin:40px auto;
    }
    .chart { width:100%; height:300px; }
  </style>
</head>
<body>

  <h1 style="text-align:center">Pittsburgh Neighborhood Explorer</h1>
  <div id="top">
    <div id="map"></div>
    <div id="bar-chart"></div>
  </div>
  <div id="charts">
    <div id="chart1" class="chart"></div>
    <div id="chart2" class="chart"></div>
    <div id="chart3" class="chart"></div>
    <div id="chart4" class="chart"></div>
  </div>

  <script>
  Promise.all([
    fetch("tracts_with_hood.geojson").then(r=>r.json()),
    fetch("combined_data.json").then(r=>r.json())
  ]).then(([geojson, combined]) => {

    // ─── CONFIG ───────────────────────────────────────────────────────────────
    const metrics = [
      "Median home value",
      "Median household income",
      "Median monthly contract rent",
      "Vacant housing units"
    ];
    const demoCats = [
      "Total population",
      "Persons of white race, not Hispanic origin",
      "Persons of black race, not Hispanic origin",
      "Persons of Hispanic origin",
      "Persons of Native American race",
      "Persons of Asian race (and Pacific Islander)"
    ];
    const palette = [
      "#636efa","#ef553b","#00cc96","#ab63fa","#ffa15a",
      "#19d3f3","#ff6692","#b6e880","#ff97ff","#fecb52"
    ];

    // ─── BUILD FEATURE LISTS ────────────────────────────────────────────────────
    const features = geojson.features.filter(f => f.properties.HOOD);
    const geoidList = features.map(f => f.properties.GEOID);
    const hoodList  = features.map(f => f.properties.HOOD);

    // reverse lookup: HOOD → [GEOID...]
    const hoodToGeo = {};
    features.forEach(f => {
      const h = f.properties.HOOD, g = f.properties.GEOID;
      (hoodToGeo[h] = hoodToGeo[h]||[]).push(g);
    });
    // include city‐wide
    hoodToGeo["All Pittsburgh"] = geoidList.slice();

    // ─── DEMO AGGREGATION FROM GEOJSON ──────────────────────────────────
    const hoodDemo = {};
    features.forEach(f => {
      const h = f.properties.HOOD;
      hoodDemo[h] = hoodDemo[h] || demoCats.reduce((o,cat)=>(o[cat]=0,o), {});
      demoCats.forEach(cat => {
        hoodDemo[h][cat] += Number(f.properties[cat])||0;
      });
    });
    // city‐wide totals
    hoodDemo["All Pittsburgh"] = demoCats.reduce((o,cat)=>{
      o[cat] = Object.values(hoodDemo).reduce((s,hmap)=>s + hmap[cat], 0);
      return o;
    }, {});

    // ─── TIME-SERIES PREP ───────────────────────────────────────────────────────
    const years = Array.from(new Set(combined.map(d=>+d.Year))).sort();
    const latestYear = years[years.length-1];

    // ─── INITIAL MAP ────────────────────────────────────────────────────────────
    Plotly.newPlot("map",[{
      type: "choroplethmapbox",
      geojson,
      locations: geoidList,
      z: Array(geoidList.length).fill(0),
      colorscale: [[0,"rgba(0,0,0,0)"],[1,"rgba(0,0,0,0)"]],
      zmin:0, zmax:1,
      featureidkey:"properties.GEOID",
      marker:{
        opacity:1,
        line:{
          color:Array(geoidList.length).fill("#555555"),
          width:Array(geoidList.length).fill(0.5)
        }
      },
      customdata: geoidList,
      text: hoodList,
      hovertemplate: "Tract %{location}<br>Neighborhood: %{text}<extra></extra>",
      showscale:false
    }],{
      mapbox:{style:"open-street-map", zoom:11, center:{lat:40.4406,lon:-79.9959}},
      margin:{t:30,r:0,l:0,b:0},
      clickmode:"event",
      title:"Click tracts to toggle neighborhoods"
    });

    // ─── DRAW TIME‐SERIES ────────────────────────────────────────────────────────
    function drawTimeSeries(selectedHoods) {
      const hoods = (selectedHoods && selectedHoods.length) 
                  ? selectedHoods 
                  : ["All Pittsburgh"];

      metrics.forEach((metric, idx) => {
        const traces = hoods.map((h, i) => {
          // average across tracts in hood per year
          const geoids = hoodToGeo[h];
          const xs = [], ys = [];
          years.forEach(y => {
            const rows = combined.filter(d =>
              +d.Year === y && geoids.includes(d.GEOID)
            );
            const vals = rows.map(d => d[metric]||0);
            const avg  = vals.length
                       ? vals.reduce((s,v)=>s+v,0) / vals.length
                       : null;
            xs.push(y);
            ys.push(avg);
          });
          return {
            type: 'scatter',
            mode: 'lines+markers',
            name: h,
            x: xs,
            y: ys,
            line:   { color: palette[i] },
            marker: { color: palette[i] }
          };
        });

        Plotly.react("chart"+(idx+1), traces, {
          title: metric,
          xaxis: { title: "Year" },
          yaxis: { title: metric }
        });
      });
    }

    // ─── DRAW BAR CHART (RAW COUNTS) ────────────────────────────────────────────
    function drawBar(selectedHoods) {
      const hoods = (selectedHoods && selectedHoods.length)
                  ? selectedHoods
                  : ["All Pittsburgh"];
      const traces = hoods.map((h,i) => {
        const demo = hoodDemo[h];
        const ys = demoCats.map(cat => demo[cat]||0);
        return {
          type: "bar",
          x: demoCats,
          y: ys,
          name: h,
          marker: { color: palette[i] }
        };
      });

      Plotly.newPlot("bar-chart", traces, {
        title: `Population by Race (${latestYear})`,
        barmode: hoods.length>1? "stack":"group",
        xaxis:{ title:"Category", tickangle:-45 },
        yaxis:{ title:"Count" }
      });
    }

    // initial draw
    drawTimeSeries([]);
    drawBar([]);

    // ─── UPDATE ON CLICK ────────────────────────────────────────────────────────
    let selectedHoods = [];
    function updateDashboard() {
      // restyle map
      const newColors = geoidList.map(g => {
        const h = features.find(f=>f.properties.GEOID===g).properties.HOOD;
        const idx = selectedHoods.indexOf(h);
        return idx > -1 ? palette[idx] : "#555555";
      });
      const newWidths = geoidList.map(g => {
        const h = features.find(f=>f.properties.GEOID===g).properties.HOOD;
        return selectedHoods.includes(h)? 3 : 0.5;
      });
      Plotly.restyle("map", {
        "marker.line.color":[newColors],
        "marker.line.width":[newWidths]
      });

      drawTimeSeries(selectedHoods);
      drawBar(selectedHoods);
    }

    document.getElementById("map").on('plotly_click', ev => {
      const g = ev.points[0].customdata;
      const h = features.find(f=>f.properties.GEOID===g).properties.HOOD;
      const ix = selectedHoods.indexOf(h);
      if (ix > -1) selectedHoods.splice(ix,1);
      else          selectedHoods.push(h);
      updateDashboard();
    });

  }).catch(e=>console.error(e));
  </script>

</body>
</html>
