<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pittsburgh Neighborhood Explorer</title>
  <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>
  <style>
    body { font-family: Arial; margin:20px; }
    #top { display:flex; gap:20px; width:80%; margin:auto; }
    #map { flex:1; height:400px; }
    #bar-container {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    #bar-controls {
      display:flex;
      justify-content:center;
      width:100%;
      margin-bottom:10px;
    }
    #bar-controls button {
      background: none;
      border: none;
      color: #333;
      margin: 0 8px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #bar-controls button.active {
      background: #f5f5f5;
      border: 1px solid #333;
      border-radius: 4px;
    }
    #bar-chart { width:100%; height:360px; }
    #charts {
      display:grid; grid-template-columns:1fr 1fr; grid-gap:20px;
      width:80%; margin:40px auto;
    }
    .chart { width:100%; height:300px; }
  </style>
</head>
<body>

  <h1 style="text-align:center">Pittsburgh Neighborhood Explorer</h1>
  <div id="top">
    <div id="map"></div>
    <div id="bar-container">
      <div id="bar-controls">
        <button id="btn-percent" data-mode="percent">% Share</button>
        <button id="btn-count"   data-mode="count">Raw Count</button>
      </div>
      <div id="bar-chart"></div>
    </div>
  </div>

  <div id="charts">
    <div id="chart1" class="chart"></div>
    <div id="chart2" class="chart"></div>
    <div id="chart3" class="chart"></div>
    <div id="chart4" class="chart"></div>
  </div>

  <script>
  Promise.all([
    fetch("tracts_with_hood.geojson").then(r=>r.json()),
    fetch("combined_data.json").then(r=>r.json())
  ]).then(([geojson, combined]) => {

    // ─── CONFIG ───────────────────────────────────────────────────────────────
    const metrics = [
      "Median home value",
      "Median household income",
      "Median monthly contract rent",
      "Vacant housing units"
    ];
    const demoCats   = [
      "Total population",
      "Persons of white race, not Hispanic origin",
      "Persons of black race, not Hispanic origin",
      "Persons of Hispanic origin",
      "Persons of Native American race",
      "Persons of Asian race (and Pacific Islander)"
    ];
    const demoLabels = [
      "White",
      "Black",
      "Hispanic",
      "Native American",
      "Asian"
    ];
    const demoPalette = [
      "#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"
    ];
    const hoodPalette = [
      "#636efa","#ef553b","#00cc96","#ab63fa","#ffa15a",
      "#19d3f3","#ff6692","#b6e880","#ff97ff","#fecb52"
    ];

    // persistent color map
    let hoodColorMap = { "All Pittsburgh": hoodPalette[0] };
    let nextColorIdx = 1;

    // ─── BUILD FEATURE LISTS ────────────────────────────────────────────────────
    const features  = geojson.features.filter(f => f.properties.HOOD);
    const geoidList = features.map(f => f.properties.GEOID);

    // reverse lookup: HOOD → [GEOID...]
    const hoodToGeo = {};
    features.forEach(f => {
      const h = f.properties.HOOD, g = f.properties.GEOID;
      (hoodToGeo[h] = hoodToGeo[h]||[]).push(g);
    });
    hoodToGeo["All Pittsburgh"] = geoidList.slice();

    // ─── AGGREGATE DEMOS ─────────────────────────────────────────────────────────
    const hoodDemo = {};
    features.forEach(f => {
      const h = f.properties.HOOD;
      hoodDemo[h] = hoodDemo[h] || demoCats.reduce((o,cat)=>(o[cat]=0,o), {});
      demoCats.forEach(cat => hoodDemo[h][cat] += Number(f.properties[cat])||0 );
    });
    hoodDemo["All Pittsburgh"] = demoCats.reduce((o,cat)=>{
      o[cat] = Object.values(hoodDemo).reduce((s,h)=>s + h[cat],0);
      return o;
    }, {});

    // ─── TIME SERIES PREP ────────────────────────────────────────────────────────
    const years = Array.from(new Set(combined.map(d=>+d.Year))).sort();
    const latestYear = years[years.length-1];

    // ─── DRAW MAP ────────────────────────────────────────────────────────────────
    Plotly.newPlot("map",[{
      type:"choroplethmapbox",
      geojson, locations:geoidList, z:Array(geoidList.length).fill(0),
      colorscale:[[0,"rgba(0,0,0,0)"],[1,"rgba(0,0,0,0)"]],
      featureidkey:"properties.GEOID",
      marker:{
        opacity:1,
        line:{ color:Array(geoidList.length).fill("#555555"),
               width:Array(geoidList.length).fill(0.5) }
      },
      customdata:geoidList,
      text:features.map(f=>f.properties.HOOD),
      hovertemplate:"Tract %{location}<br>Neighborhood: %{text}<extra></extra>",
      showscale:false
    }],{
      mapbox:{style:"open-street-map",zoom:11,center:{lat:40.4406,lon:-79.9959}},
      margin:{t:30,l:0,r:0,b:0},clickmode:"event",
      title:"Click tracts to toggle neighborhoods"
    });

    // ─── DRAW TIME SERIES ───────────────────────────────────────────────────────
    function drawTimeSeries(sel) {
      const hoods = sel.length ? sel : ["All Pittsburgh"];
      metrics.forEach((m,i)=>{
        const traces = hoods.map(h=>{
          const xs=[], ys=[];
          years.forEach(y=>{
            const rows = combined.filter(d=>+d.Year===y && hoodToGeo[h].includes(d.GEOID));
            const vals = rows.map(d=>d[m]||0);
            xs.push(y);
            ys.push(vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null);
          });
          return {
            type:"scatter",mode:"lines+markers",name:h,
            x:xs,y:ys,
            line:{color:hoodColorMap[h]},marker:{color:hoodColorMap[h]}
          };
        });
        Plotly.react("chart"+(i+1),traces,{
          title:m,xaxis:{title:"Year"},yaxis:{title:m}
        });
      });
    }

    // ─── DRAW BAR ───────────────────────────────────────────────────────────────
    let barMode = "percent";
    function drawBar(sel) {
      const hoods = sel.length ? sel : ["All Pittsburgh"];
      const traces = demoCats.slice(1).map((cat,i)=>({
        type:"bar",orientation:"h",name:demoLabels[i],
        y:hoods,
        x:hoods.map(h=>{
          const val = hoodDemo[h][cat]||0;
          if(barMode==="percent"){
            const tot = Object.values(hoodDemo[h]).reduce((a,b)=>a+b,0)||1;
            return val/tot;
          }
          return val;
        }),
        marker:{color:demoPalette[i]}
      }));
      Plotly.newPlot("bar-chart",traces,{
        title: barMode==="percent"
          ? `Population Composition (${latestYear})`
          : `Population Counts (${latestYear})`,
        barmode:"stack",
        ...(barMode==="percent"
          ? { barnorm:"fraction", xaxis:{tickformat:".0%"} }
          : {}),
        xaxis:{ title: barMode==="percent" ? "Share" : "Count" },
        yaxis:{ automargin:true, title: "" }
      });
    }

    // ─── UPDATE DASHBOARD ───────────────────────────────────────────────────────
    let selectedHoods = [];
    function updateDashboard(){
      const lineCol = geoidList.map(g=>{
        const h = features.find(f=>f.properties.GEOID===g).properties.HOOD;
        return hoodColorMap[h] || "#555555";
      });
      const lineWd = geoidList.map(g=>{
        const h = features.find(f=>f.properties.GEOID===g).properties.HOOD;
        return selectedHoods.includes(h)?3:0.5;
      });
      Plotly.restyle("map",{"marker.line.color":[lineCol],"marker.line.width":[lineWd]});
      drawTimeSeries(selectedHoods);
      drawBar(selectedHoods);
    }

    // ─── INITIAL DRAW ───────────────────────────────────────────────────────────
    drawTimeSeries([]);
    drawBar([]);

    // ─── BUTTON HOOKUPS ─────────────────────────────────────────────────────────
    function setBarMode(mode) {
      barMode = mode;
      document.querySelectorAll("#bar-controls button").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.mode===mode);
      });
      drawBar(selectedHoods);
    }
    document.getElementById("btn-percent")
      .addEventListener("click", ()=> setBarMode("percent"));
    document.getElementById("btn-count")
      .addEventListener("click", ()=> setBarMode("count"));

    // kick off with percent active
    setBarMode("percent");

    // ─── MAP CLICK HANDLER ──────────────────────────────────────────────────────
    document.getElementById("map").on('plotly_click',ev=>{
      const geoid = ev.points[0].customdata;
      const hood  = features.find(f=>f.properties.GEOID===geoid).properties.HOOD;
      if(!(hood in hoodColorMap)){
        hoodColorMap[hood] = hoodPalette[nextColorIdx % hoodPalette.length];
        nextColorIdx++;
      }
      const i = selectedHoods.indexOf(hood);
      if(i>-1) selectedHoods.splice(i,1);
      else      selectedHoods.push(hood);
      updateDashboard();
    });

  }).catch(e=>console.error(e));
  </script>

</body>
</html>
