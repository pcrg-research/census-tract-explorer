<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pittsburgh Tract Explorer (Static)</title>
  <!-- Plotly.js from CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { width: 60%; height: 400px; margin: auto; }
    #charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      width: 80%; margin: 40px auto;
    }
    .chart { width: 100%; height: 300px; }
  </style>
</head>
<body>

  <h1 style="text-align:center">Pittsburgh Tract Explorer</h1>
  <div id="map"></div>
  <div id="charts">
    <div id="chart1" class="chart"></div>
    <div id="chart2" class="chart"></div>
    <div id="chart3" class="chart"></div>
    <div id="chart4" class="chart"></div>
  </div>

  <script>
  // 1) Fetch both files in parallel
  Promise.all([
    fetch("census_tracts.geojson").then(r => r.json()),
    fetch("combined_data.json").then(r => r.json())
  ]).then(([geojson, combined]) => {

    // 2) Prep
    const metrics = [
      "Median home value",
      "Median household income",
      "Median monthly contract rent",
      "Vacant housing units"
    ];
    // Extract unique tract GEOIDs (excluding the 'All Pittsburgh' row)
    const geoidList = Array.from(new Set(
      combined.map(d => d.GEOID).filter(g => g !== "All Pittsburgh")
    ));
    // We'll allow "All Pittsburgh" when nothing is selected
    let selected = [];

    // Qualitative palette (Plotly default)
    const palette = Plotly.d3.schemeCategory10;

    // 3) Draw the initial map
    const mapTrace = {
      type: "choroplethmapbox",
      geojson: geojson,
      locations: geoidList,
      z: Array(geoidList.length).fill(0), // dummy
      featureidkey: "properties.GEOID",
      marker: {
        opacity: 0.5,
        line: {
          color: Array(geoidList.length).fill("white"),
          width: Array(geoidList.length).fill(0.5)
        }
      },
      customdata: geoidList,
      showscale: false
    };
    const mapLayout = {
      mapbox: {
        style: "open-street-map",
        zoom: 11,
        center: { lat: 40.4406, lon: -79.9959 }
      },
      margin: { t:30, r:0, l:0, b:0 },
      clickmode: "event+select",
      title: "Click a Tract to (De)Select"
    };
    Plotly.newPlot("map", [mapTrace], mapLayout);

    // 4) Handler to update map styling & charts
    function updateMapAndCharts() {
      // -- Update map borders
      const newLineColor = geoidList.map(g =>
        selected.includes(g)
          ? palette[selected.indexOf(g) % palette.length]
          : "white"
      );
      const newLineWidth = geoidList.map(g =>
        selected.includes(g) ? 3 : 0.5
      );
      Plotly.restyle("map", {
        "marker.line.color": [newLineColor],
        "marker.line.width": [newLineWidth]
      });

      // -- Determine which GEOIDs to plot
      const toPlot = selected.length ? selected : ["All Pittsburgh"];

      // -- Update each chart
      toPlot.forEach((g, idx) => {
        const col = palette[idx % palette.length];
        metrics.forEach((m, mi) => {
          const chartId = "chart" + (mi+1);
          // Filter data
          const df = combined.filter(d => d.GEOID === g);
          const trace = {
            x: df.map(d => d.Year),
            y: df.map(d => d[m]),
            mode: "lines+markers",
            name: g,
            line: { color: col },
            marker: { color: col }
          };
          // If first render, use newPlot; else, restyle
          if (idx === 0 && /*check if chart empty by div having no children*/ !document.getElementById(chartId).data) {
            Plotly.newPlot(chartId, [trace], {
              title: m,
              xaxis: { title: "Year" },
              yaxis: { title: m }
            });
          } else {
            Plotly.react(chartId, [trace], {
              title: m,
              xaxis: { title: "Year" },
              yaxis: { title: m }
            });
          }
        });
      });

      // If multiple tracts selected, you may want to overlay them:
      // you can adapt the above to push multiple traces per chart.
    }

    // 5) Wire up click handler
    const mapDiv = document.getElementById("map");
    mapDiv.on('plotly_click', pts => {
      const geoid = pts.points[0].customdata;
      const idx = selected.indexOf(geoid);
      if (idx > -1) selected.splice(idx, 1);
      else             selected.push(geoid);
      updateMapAndCharts();
    });

    // 6) Initial draw of charts with "All Pittsburgh"
    updateMapAndCharts();

  }).catch(console.error);
  </script>

</body>
</html>
